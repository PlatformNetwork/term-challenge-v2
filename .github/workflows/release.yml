name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: blacksmith-32vcpu-ubuntu-2404
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build-release:
    name: Build Release Artifacts
    runs-on: blacksmith-32vcpu-ubuntu-2404
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: "term-ci"

      - name: Build release binaries
        run: cargo build --release

      - name: Package binaries
        run: |
          mkdir -p release
          cp target/release/term release/ 2>/dev/null || true
          tar -czvf term-challenge-${{ needs.release-please.outputs.version }}-linux-x86_64.tar.gz -C release .

      - name: Upload release artifacts
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            term-challenge-${{ needs.release-please.outputs.version }}-linux-x86_64.tar.gz

  wasm-release:
    name: WASM Release
    runs-on: blacksmith-32vcpu-ubuntu-2404
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: "term-ci"

      - name: Build WASM module
        run: |
          cargo build --release --target wasm32-unknown-unknown \
            -p term-challenge-wasm --no-default-features

      - name: Prepare WASM artifact
        run: |
          WASM_PATH="target/wasm32-unknown-unknown/release/term_challenge_wasm.wasm"
          cp "$WASM_PATH" term_challenge_wasm.wasm
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum term_challenge_wasm.wasm > term_challenge_wasm.wasm.sha256
          fi

      - name: Upload WASM to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            term_challenge_wasm.wasm
            term_challenge_wasm.wasm.sha256
