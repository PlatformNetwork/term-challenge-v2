version: '3.8'

# Test Environment: 1 Central Server + 4 Validators + PostgreSQL
# Reproduces exact production flow without Bittensor

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: term
      POSTGRES_PASSWORD: termpass
      POSTGRES_DB: term_challenge
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U term -d term_challenge"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Central Server (subnet owner mode)
  central-server:
    build:
      context: ..
      dockerfile: Dockerfile.server
    environment:
      - DATABASE_URL=postgres://term:termpass@postgres:5432/term_challenge
      - HOST=0.0.0.0
      - PORT=8081
      - RUST_LOG=info,term_challenge=debug
      - TEST_MODE=true
      - PLATFORM_URL=http://central-server:8081
      - CHALLENGE_ID=test-challenge
      - SERVER_SECRET=test-secret-key-for-encryption-32b
      # Whitelist our 4 test validators (these are test SS58 addresses)
      - VALIDATOR_WHITELIST=5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY,5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty,5FLSigC9HGRKVhB9FiEo4Y3koPsNmBmLJbpXg2mp1hXcS59Y,5DAAnrj7VHTznn2AWBemMuyBwZWs6FNFjdyVXUeYum3PTXFy

    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - term-network

  # Validator 1 (Alice)
  validator-1:
    build:
      context: ..
      dockerfile: Dockerfile.server
    environment:
      - RUST_LOG=info,term_challenge=debug
      - PLATFORM_URL=http://central-server:8081
      - CHALLENGE_ID=test-challenge
      - TEST_MODE=true
      - VALIDATOR_HOTKEY=5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY
      - VALIDATOR_MODE=true
    depends_on:
      - central-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - term-network

  # Validator 2 (Bob)
  validator-2:
    build:
      context: ..
      dockerfile: Dockerfile.server
    environment:
      - RUST_LOG=info,term_challenge=debug
      - PLATFORM_URL=http://central-server:8081
      - CHALLENGE_ID=test-challenge
      - TEST_MODE=true
      - VALIDATOR_HOTKEY=5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty
      - VALIDATOR_MODE=true
    depends_on:
      - central-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - term-network

  # Validator 3 (Charlie)
  validator-3:
    build:
      context: ..
      dockerfile: Dockerfile.server
    environment:
      - RUST_LOG=info,term_challenge=debug
      - PLATFORM_URL=http://central-server:8081
      - CHALLENGE_ID=test-challenge
      - TEST_MODE=true
      - VALIDATOR_HOTKEY=5FLSigC9HGRKVhB9FiEo4Y3koPsNmBmLJbpXg2mp1hXcS59Y
      - VALIDATOR_MODE=true
    depends_on:
      - central-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - term-network

  # Validator 4 (Dave)
  validator-4:
    build:
      context: ..
      dockerfile: Dockerfile.server
    environment:
      - RUST_LOG=info,term_challenge=debug
      - PLATFORM_URL=http://central-server:8081
      - CHALLENGE_ID=test-challenge
      - TEST_MODE=true
      - VALIDATOR_HOTKEY=5DAAnrj7VHTznn2AWBemMuyBwZWs6FNFjdyVXUeYum3PTXFy
      - VALIDATOR_MODE=true
    depends_on:
      - central-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - term-network

volumes:
  postgres_data:

networks:
  term-network:
    driver: bridge
