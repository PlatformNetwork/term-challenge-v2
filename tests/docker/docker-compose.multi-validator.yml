# =============================================================================
# Platform Multi-Validator Test Network
# =============================================================================
# For comprehensive production-like testing with 4 validators in P2P network
#
# Usage:
#   docker compose -f tests/docker/docker-compose.multi-validator.yml up --build -d
#   docker compose -f tests/docker/docker-compose.multi-validator.yml logs -f
#   docker compose -f tests/docker/docker-compose.multi-validator.yml down -v
# =============================================================================

services:
  # ==========================================================================
  # Mock Subtensor RPC
  # ==========================================================================
  mock-subtensor:
    build:
      context: ../..
      dockerfile: bins/mock-subtensor/Dockerfile
    container_name: platform-mock-subtensor
    hostname: mock-subtensor
    environment:
      - RUST_LOG=info,mock_subtensor=debug
      - MOCK_SUBTENSOR_BIND=0.0.0.0:9944
      - MOCK_SUBTENSOR_TEMPO=12
      - MOCK_SUBTENSOR_NETUID=100
      - MOCK_SUBTENSOR_VALIDATOR_COUNT=256
      - MOCK_SUBTENSOR_COMMIT_REVEAL=true
    ports:
      - "9944:9944"
    networks:
      platform-test:
        ipv4_address: 172.28.1.10
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9944/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

  # ==========================================================================
  # Validator 1 (Bootstrap node)
  # ==========================================================================
  validator-1:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-validator
    container_name: platform-validator-1
    hostname: validator-1
    environment:
      - RUST_LOG=info,validator_node=debug,platform_p2p_consensus=debug
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=0x0000000000000000000000000000000000000000000000000000000000000001
      - P2P_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - NETUID=100
      - NO_BITTENSOR=false
      - SUBTENSOR_ENDPOINT=ws://mock-subtensor:9944
      - PLATFORM_TEST_ARTIFACTS_DIR=/artifacts
      - PLATFORM_TEST_TMP_BASE=/tmp/platform-tests
    ports:
      - "9001:9000"
    volumes:
      - validator1-data:/data
      - test-artifacts:/artifacts
    networks:
      platform-test:
        ipv4_address: 172.28.1.1
    depends_on:
      mock-subtensor:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -e /data/distributed.db || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

  # ==========================================================================
  # Validator 2
  # ==========================================================================
  validator-2:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-validator
    container_name: platform-validator-2
    hostname: validator-2
    environment:
      - RUST_LOG=info,validator_node=debug,platform_p2p_consensus=debug
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=0x0000000000000000000000000000000000000000000000000000000000000002
      - P2P_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - NETUID=100
      - NO_BITTENSOR=false
      - BOOTSTRAP_PEERS=/ip4/172.28.1.1/tcp/9000
      - SUBTENSOR_ENDPOINT=ws://mock-subtensor:9944
      - PLATFORM_TEST_ARTIFACTS_DIR=/artifacts
      - PLATFORM_TEST_TMP_BASE=/tmp/platform-tests
    ports:
      - "9002:9000"
    volumes:
      - validator2-data:/data
      - test-artifacts:/artifacts
    networks:
      platform-test:
        ipv4_address: 172.28.1.2
    depends_on:
      mock-subtensor:
        condition: service_healthy
      validator-1:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "test -e /data/distributed.db || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

  # ==========================================================================
  # Validator 3
  # ==========================================================================
  validator-3:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-validator
    container_name: platform-validator-3
    hostname: validator-3
    environment:
      - RUST_LOG=info,validator_node=debug,platform_p2p_consensus=debug
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=0x0000000000000000000000000000000000000000000000000000000000000003
      - P2P_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - NETUID=100
      - NO_BITTENSOR=false
      - BOOTSTRAP_PEERS=/ip4/172.28.1.1/tcp/9000
      - SUBTENSOR_ENDPOINT=ws://mock-subtensor:9944
      - PLATFORM_TEST_ARTIFACTS_DIR=/artifacts
      - PLATFORM_TEST_TMP_BASE=/tmp/platform-tests
    ports:
      - "9003:9000"
    volumes:
      - validator3-data:/data
      - test-artifacts:/artifacts
    networks:
      platform-test:
        ipv4_address: 172.28.1.3
    depends_on:
      mock-subtensor:
        condition: service_healthy
      validator-1:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "test -e /data/distributed.db || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

  # ==========================================================================
  # Validator 4
  # ==========================================================================
  validator-4:
    build:
      context: ../..
      dockerfile: tests/docker/Dockerfile.test-validator
    container_name: platform-validator-4
    hostname: validator-4
    environment:
      - RUST_LOG=info,validator_node=debug,platform_p2p_consensus=debug
      - DATA_DIR=/data
      - VALIDATOR_SECRET_KEY=0x0000000000000000000000000000000000000000000000000000000000000004
      - P2P_LISTEN_ADDR=/ip4/0.0.0.0/tcp/9000
      - NETUID=100
      - NO_BITTENSOR=false
      - BOOTSTRAP_PEERS=/ip4/172.28.1.1/tcp/9000
      - SUBTENSOR_ENDPOINT=ws://mock-subtensor:9944
      - PLATFORM_TEST_ARTIFACTS_DIR=/artifacts
      - PLATFORM_TEST_TMP_BASE=/tmp/platform-tests
    ports:
      - "9004:9000"
    volumes:
      - validator4-data:/data
      - test-artifacts:/artifacts
    networks:
      platform-test:
        ipv4_address: 172.28.1.4
    depends_on:
      mock-subtensor:
        condition: service_healthy
      validator-1:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "test -e /data/distributed.db || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s

volumes:
  validator1-data:
  validator2-data:
  validator3-data:
  validator4-data:
  test-artifacts:

networks:
  platform-test:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
