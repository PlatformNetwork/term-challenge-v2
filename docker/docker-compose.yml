# Platform Validator Docker Compose
# For local development and testing
#
# Challenges are maintained in separate repositories and import
# platform-challenge-sdk as a git dependency.  Add your challenge
# service below following the example template.

version: '3.8'

services:
  # ===== Core Validator =====
  validator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.validator
    container_name: platform-validator
    restart: unless-stopped
    environment:
      - VALIDATOR_SECRET_KEY=${VALIDATOR_SECRET_KEY}
      - SUBTENSOR_ENDPOINT=${SUBTENSOR_ENDPOINT:-wss://entrypoint-finney.opentensor.ai:443}
      - P2P_PORT=9000
      - RPC_PORT=8080
      - RUST_LOG=info
    volumes:
      - validator-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "9000:9000"   # P2P
      - "8080:8080"   # RPC
    networks:
      - platform
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===== Example Challenge (uncomment and customise) =====
  # challenge-example:
  #   build:
  #     context: ../..
  #     dockerfile: docker/Dockerfile.challenge
  #     args:
  #       CHALLENGE_NAME: my-challenge
  #       CHALLENGE_DIR: challenges/my-challenge
  #   image: your-org/challenge-example:latest
  #   container_name: challenge-example
  #   restart: unless-stopped
  #   environment:
  #     - RUST_LOG=info
  #     - CHALLENGE_PORT=8080
  #   volumes:
  #     - challenge-data:/data
  #   networks:
  #     - platform
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 30s

networks:
  platform:
    driver: bridge
    name: platform

volumes:
  validator-data:
